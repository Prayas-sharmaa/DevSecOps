{"filter":false,"title":"ci-cd.yml","tooltip":"/.github/workflows/ci-cd.yml","undoManager":{"mark":5,"position":5,"stack":[[{"start":{"row":104,"column":77},"end":{"row":105,"column":0},"action":"remove","lines":["",""],"id":2,"ignore":true}],[{"start":{"row":104,"column":77},"end":{"row":134,"column":0},"action":"insert","lines":["","  ansible-deploy:","    runs-on: ubuntu-latest","    needs: Infrastructure","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout repository","        uses: actions/checkout@v4","","      - name: Install Ansible","        run: |","          sudo apt update","          sudo apt install -y ansible","","      - name: Prepare SSH key for Ansible","        run: |","          echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","          chmod 600 private_key.pem","","      - name: Run Ansible Playbook (Datadog setup)","        run: |","          ansible-playbook \\","            -i ansible/inventories/hosts.ini \\","            --key-file private_key.pem \\","            ansible/playbooks/configure_datadog.yml",""],"id":3,"ignore":true}],[{"start":{"row":0,"column":0},"end":{"row":134,"column":0},"action":"remove","lines":["name: DevSecOps CI","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} ","        with:","          args:","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","","    steps:","    - uses: actions/checkout@v4","    - name: Set up Python ${{ matrix.python-version }}","      uses: actions/setup-python@v3","      with:","        python-version: ${{ matrix.python-version }}","    - name: Install Dependencies","      run: |","        python -m pip install --upgrade pip","        pip install -r requirements.txt","    - name: Run Tests","      run: |","        python manage.py test","","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build and push Docker image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  Infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: \"us-east-1\"","","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check if Elastic Beanstalk app exists","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","          else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Skip or Run Terraform","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped (EB already deployed)","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\" ","  ansible-deploy:","    runs-on: ubuntu-latest","    needs: Infrastructure","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout repository","        uses: actions/checkout@v4","","      - name: Install Ansible","        run: |","          sudo apt update","          sudo apt install -y ansible","","      - name: Prepare SSH key for Ansible","        run: |","          echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","          chmod 600 private_key.pem","","      - name: Run Ansible Playbook (Datadog setup)","        run: |","          ansible-playbook \\","            -i ansible/inventories/hosts.ini \\","            --key-file private_key.pem \\","            ansible/playbooks/configure_datadog.yml",""],"id":4},{"start":{"row":0,"column":0},"end":{"row":139,"column":0},"action":"insert","lines":["name: DevSecOps CI","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}","        with:","          args: >","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","","    steps:","      - uses: actions/checkout@v4","","      - name: Set up Python ${{ matrix.python-version }}","        uses: actions/setup-python@v4","        with:","          python-version: ${{ matrix.python-version }}","","      - name: Install Dependencies","        run: |","          python -m pip install --upgrade pip","          pip install -r requirements.txt","","      - name: Run Tests","        run: |","          python manage.py test","","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build and push Docker image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  Infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check if Elastic Beanstalk environment exists","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","            else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Apply Terraform (Only if EB is not deployed)","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped (EB already deployed)","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\"","","  ansible-deploy:","    runs-on: ubuntu-latest","    needs: Infrastructure","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}","","    steps:","      - name: Checkout repository","        uses: actions/checkout@v4","","      - name: Install Ansible","        run: |","          sudo apt update","          sudo apt install -y ansible","","      - name: Prepare SSH key for Ansible","        run: |","          echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","          chmod 600 private_key.pem","","      - name: Run Ansible Playbook (Datadog setup)","        run: |","          ansible-playbook \\","            -i ansible/inventories/hosts.ini \\","            --key-file private_key.pem \\","            ansible/playbooks/configure_datadog.yml",""]}],[{"start":{"row":0,"column":0},"end":{"row":139,"column":0},"action":"remove","lines":["name: DevSecOps CI","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}","        with:","          args: >","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","","    steps:","      - uses: actions/checkout@v4","","      - name: Set up Python ${{ matrix.python-version }}","        uses: actions/setup-python@v4","        with:","          python-version: ${{ matrix.python-version }}","","      - name: Install Dependencies","        run: |","          python -m pip install --upgrade pip","          pip install -r requirements.txt","","      - name: Run Tests","        run: |","          python manage.py test","","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build and push Docker image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  Infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check if Elastic Beanstalk environment exists","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","            else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Apply Terraform (Only if EB is not deployed)","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped (EB already deployed)","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\"","","  ansible-deploy:","    runs-on: ubuntu-latest","    needs: Infrastructure","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}","","    steps:","      - name: Checkout repository","        uses: actions/checkout@v4","","      - name: Install Ansible","        run: |","          sudo apt update","          sudo apt install -y ansible","","      - name: Prepare SSH key for Ansible","        run: |","          echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","          chmod 600 private_key.pem","","      - name: Run Ansible Playbook (Datadog setup)","        run: |","          ansible-playbook \\","            -i ansible/inventories/hosts.ini \\","            --key-file private_key.pem \\","            ansible/playbooks/configure_datadog.yml",""],"id":13},{"start":{"row":0,"column":0},"end":{"row":144,"column":0},"action":"insert","lines":["name: DevSecOps CI","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}","        with:","          args: >","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","","    steps:","      - uses: actions/checkout@v4","","      - name: Set up Python","        uses: actions/setup-python@v4","        with:","          python-version: ${{ matrix.python-version }}","","      - name: Install Dependencies","        run: |","          python -m pip install --upgrade pip","          pip install -r requirements.txt","","      - name: Run Tests","        run: python manage.py test","","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build & Push Docker Image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  Infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check EB environment","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","          else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Apply Terraform (deploy only once)","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\"","","  ansible-deploy:","    runs-on: ubuntu-latest","    needs: Infrastructure","","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}","","    steps:","      - name: Checkout repository","        uses: actions/checkout@v4","","      - name: Install Ansible + dependencies","        run: |","          sudo apt update","          sudo apt install -y ansible","","      - name: Install required Ansible roles","        run: |","          ansible-galaxy install -r ansible/requirements.yml","","      - name: Prepare SSH key for Ansible","        run: |","          echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","          chmod 600 private_key.pem","","      - name: Run Datadog Playbook","        run: |","          ansible-playbook \\","            -i ansible/inventories/hosts.ini \\","            --key-file private_key.pem \\","            ansible/playbooks/configure_datadog.yml",""]}],[{"start":{"row":109,"column":2},"end":{"row":109,"column":4},"action":"insert","lines":["# "],"id":14},{"start":{"row":110,"column":2},"end":{"row":110,"column":4},"action":"insert","lines":["# "]},{"start":{"row":111,"column":2},"end":{"row":111,"column":4},"action":"insert","lines":["# "]},{"start":{"row":113,"column":2},"end":{"row":113,"column":4},"action":"insert","lines":["# "]},{"start":{"row":114,"column":2},"end":{"row":114,"column":4},"action":"insert","lines":["# "]},{"start":{"row":115,"column":2},"end":{"row":115,"column":4},"action":"insert","lines":["# "]},{"start":{"row":116,"column":2},"end":{"row":116,"column":4},"action":"insert","lines":["# "]},{"start":{"row":117,"column":2},"end":{"row":117,"column":4},"action":"insert","lines":["# "]},{"start":{"row":118,"column":2},"end":{"row":118,"column":4},"action":"insert","lines":["# "]},{"start":{"row":120,"column":2},"end":{"row":120,"column":4},"action":"insert","lines":["# "]},{"start":{"row":121,"column":2},"end":{"row":121,"column":4},"action":"insert","lines":["# "]},{"start":{"row":122,"column":2},"end":{"row":122,"column":4},"action":"insert","lines":["# "]},{"start":{"row":124,"column":2},"end":{"row":124,"column":4},"action":"insert","lines":["# "]},{"start":{"row":125,"column":2},"end":{"row":125,"column":4},"action":"insert","lines":["# "]},{"start":{"row":126,"column":2},"end":{"row":126,"column":4},"action":"insert","lines":["# "]},{"start":{"row":127,"column":2},"end":{"row":127,"column":4},"action":"insert","lines":["# "]},{"start":{"row":129,"column":2},"end":{"row":129,"column":4},"action":"insert","lines":["# "]},{"start":{"row":130,"column":2},"end":{"row":130,"column":4},"action":"insert","lines":["# "]},{"start":{"row":131,"column":2},"end":{"row":131,"column":4},"action":"insert","lines":["# "]},{"start":{"row":133,"column":2},"end":{"row":133,"column":4},"action":"insert","lines":["# "]},{"start":{"row":134,"column":2},"end":{"row":134,"column":4},"action":"insert","lines":["# "]},{"start":{"row":135,"column":2},"end":{"row":135,"column":4},"action":"insert","lines":["# "]},{"start":{"row":136,"column":2},"end":{"row":136,"column":4},"action":"insert","lines":["# "]},{"start":{"row":138,"column":2},"end":{"row":138,"column":4},"action":"insert","lines":["# "]},{"start":{"row":139,"column":2},"end":{"row":139,"column":4},"action":"insert","lines":["# "]},{"start":{"row":140,"column":2},"end":{"row":140,"column":4},"action":"insert","lines":["# "]},{"start":{"row":141,"column":2},"end":{"row":141,"column":4},"action":"insert","lines":["# "]},{"start":{"row":142,"column":2},"end":{"row":142,"column":4},"action":"insert","lines":["# "]},{"start":{"row":143,"column":2},"end":{"row":143,"column":4},"action":"insert","lines":["# "]}],[{"start":{"row":0,"column":0},"end":{"row":144,"column":0},"action":"remove","lines":["name: DevSecOps CI","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}","        with:","          args: >","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","","    steps:","      - uses: actions/checkout@v4","","      - name: Set up Python","        uses: actions/setup-python@v4","        with:","          python-version: ${{ matrix.python-version }}","","      - name: Install Dependencies","        run: |","          python -m pip install --upgrade pip","          pip install -r requirements.txt","","      - name: Run Tests","        run: python manage.py test","","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build & Push Docker Image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  Infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check EB environment","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","          else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Apply Terraform (deploy only once)","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\"","","  # ansible-deploy:","  #   runs-on: ubuntu-latest","  #   needs: Infrastructure","","  #   env:","  #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","  #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","  #     AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","  #     AWS_REGION: us-east-1","  #     DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}","","  #   steps:","  #     - name: Checkout repository","  #       uses: actions/checkout@v4","","  #     - name: Install Ansible + dependencies","  #       run: |","  #         sudo apt update","  #         sudo apt install -y ansible","","  #     - name: Install required Ansible roles","  #       run: |","  #         ansible-galaxy install -r ansible/requirements.yml","","  #     - name: Prepare SSH key for Ansible","  #       run: |","  #         echo \"${{ secrets.EB_SSH_KEY }}\" > private_key.pem","  #         chmod 600 private_key.pem","","  #     - name: Run Datadog Playbook","  #       run: |","  #         ansible-playbook \\","  #           -i ansible/inventories/hosts.ini \\","  #           --key-file private_key.pem \\","  #           ansible/playbooks/configure_datadog.yml",""],"id":15},{"start":{"row":0,"column":0},"end":{"row":178,"column":0},"action":"insert","lines":["name: DevSecOps CI/CD","","on:","  push:","    branches: [ main ]","  pull_request:","    branches: [ main ]","","jobs:","","  # ========================","  # 1️⃣ SonarCloud Analysis","  # ========================","  sonar-cloud-build:","    runs-on: ubuntu-latest","    steps:","      - name: Checkout code","        uses: actions/checkout@v4","","      - name: Analyze with SonarCloud","        uses: SonarSource/sonarcloud-github-action@v2","        env:","          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}","        with:","          args: >","            -Dsonar.projectKey=Prayas-sharmaa_DevSecOps","            -Dsonar.organization=prayas-sharmaa","","  # ========================","  # 2️⃣ Python Build & Tests","  # ========================","  python-build:","    runs-on: ubuntu-latest","    needs: sonar-cloud-build","    strategy:","      matrix:","        python-version: ['3.10']","    steps:","      - uses: actions/checkout@v4","","      - name: Set up Python","        uses: actions/setup-python@v4","        with:","          python-version: ${{ matrix.python-version }}","","      - name: Install Dependencies","        run: |","          python -m pip install --upgrade pip","          pip install -r requirements.txt","","      - name: Run Tests","        run: python manage.py test","","  # ========================","  # 3️⃣ Docker Build & Push","  # ========================","  docker-build:","    runs-on: ubuntu-latest","    needs: python-build","    steps:","      - uses: actions/checkout@v4","","      - name: Log in to Docker Hub","        uses: docker/login-action@v3","        with:","          username: ${{ secrets.DOCKERHUB_USERNAME }}","          password: ${{ secrets.DOCKERHUB_TOKEN }}","","      - name: Build & Push Docker Image","        uses: docker/build-push-action@v6","        with:","          context: .","          push: true","          tags: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","","  # ========================","  # 4️⃣ Terraform Infrastructure (only once)","  # ========================","  infrastructure:","    runs-on: ubuntu-latest","    needs: docker-build","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","    steps:","      - uses: actions/checkout@v4","","      - name: Install Terraform","        uses: hashicorp/setup-terraform@v3","","      - name: Check EB environment","        id: ebe_check","        run: |","          if aws elasticbeanstalk describe-environments \\","              --region $AWS_REGION \\","              --environment-names \"storemanagement-env\" >/dev/null 2>&1; then","              echo \"exists=true\" >> $GITHUB_OUTPUT","          else","              echo \"exists=false\" >> $GITHUB_OUTPUT","          fi","","      - name: Apply Terraform (deploy only once)","        if: steps.ebe_check.outputs.exists == 'false'","        run: |","          cd terraform","          terraform init","          terraform validate","          terraform plan -out=tfplan","          terraform apply -auto-approve tfplan","","      - name: Terraform skipped","        if: steps.ebe_check.outputs.exists == 'true'","        run: echo \"Elastic Beanstalk already deployed — skipping Terraform.\"","","  # ========================","  # 5️⃣ Deploy Docker to Elastic Beanstalk","  # ========================","  deploy-to-eb:","    runs-on: ubuntu-latest","    needs: infrastructure","    env:","      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}","      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}","      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}","      AWS_REGION: us-east-1","      DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/storemanagement:latest","      S3_BUCKET: storemanagement-eb-bucket","      EB_APP: storemanagement-app","      EB_ENV: storemanagement-env","","    steps:","      - uses: actions/checkout@v4","","      - name: Install AWS CLI & zip","        run: |","          sudo apt update","          sudo apt install -y awscli zip","","      - name: Create Dockerrun.aws.json","        run: |","          cat > Dockerrun.aws.json <<EOF","          {","            \"AWSEBDockerrunVersion\": 1,","            \"Image\": {","              \"Name\": \"${DOCKER_IMAGE}\",","              \"Update\": \"true\"","            },","            \"Ports\": [","              {","                \"ContainerPort\": 8000","              }","            ]","          }","          EOF","","      - name: Zip Dockerrun","        run: zip deploy.zip Dockerrun.aws.json","","      - name: Upload to S3","        run: aws s3 cp deploy.zip s3://$S3_BUCKET/deploy-$(date +%s).zip","","      - name: Create EB application version","        run: |","          VERSION=\"v-$(date +%s)\"","          S3_FILE=\"deploy-$(date +%s).zip\"","          aws elasticbeanstalk create-application-version \\","            --application-name \"$EB_APP\" \\","            --version-label \"$VERSION\" \\","            --source-bundle S3Bucket=\"$S3_BUCKET\",S3Key=\"$S3_FILE\"","          echo \"VERSION=$VERSION\" >> $GITHUB_ENV","","      - name: Deploy EB Environment","        run: |","          aws elasticbeanstalk update-environment \\","            --environment-name \"$EB_ENV\" \\","            --version-label \"$VERSION\"",""]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":178,"column":0},"end":{"row":178,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1765066689905,"hash":"b3228214e124e21e8fedb766bbe8af191d795a00"}